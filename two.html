<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edu-Gen Prime: Lesson Architect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        /* --- Base and Font Styles --- */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #030712; /* Richer, darker blue-gray */
            color: #E5E7EB;
        }

        .orbitron {
            font-family: 'Orbitron', sans-serif;
        }

        /* --- Glassmorphism & Glow Effects --- */
        .glass-pane {
            background: rgba(17, 24, 39, 0.6); /* Semi-transparent dark bg */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 212, 255, 0.15);
            box-shadow: 0 0 40px rgba(0, 255, 255, 0.08);
        }

        .glowing-text {
            text-shadow: 0 0 5px #00d4ff, 0 0 10px #00d4ff, 0 0 15px #00d4ff;
        }

        /* --- Form & Input Styling --- */
        .form-input {
            background-color: rgba(3, 7, 18, 0.7); /* Darker input bg */
            border: 1px solid rgba(0, 212, 255, 0.3);
            transition: all 0.3s ease;
            color: #f3f4f6;
        }

        .form-input::placeholder {
            color: #6b7280;
        }

        .form-input:focus {
            background-color: rgba(3, 7, 18, 1);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
            border-color: #00d4ff;
            outline: none;
        }

        .form-checkbox:checked {
            background-color: #00d4ff;
            border-color: #00d4ff;
        }

        /* --- Button Styling --- */
        .btn-primary {
            background: linear-gradient(45deg, #00d4ff, #0a59cc);
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
            color: white;
            border: none;
        }

        .btn-primary:hover:not(:disabled) {
            transform: scale(1.02);
            box-shadow: 0 0 25px rgba(0, 212, 255, 0.6);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* --- Animations --- */
        .fade-in {
            animation: fadeIn 0.8s ease-in-out forwards;
            opacity: 0;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        /* --- Timeline Styling --- */
        .timeline-item {
            position: relative;
            padding-left: 30px;
            padding-bottom: 20px;
            border-left: 2px solid #00d4ff;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -9px;
            top: 0;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #00d4ff;
            box-shadow: 0 0 10px #00d4ff;
        }

        .timeline-item:last-child {
            border-left: 2px solid transparent;
            padding-bottom: 0;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <!-- Login Page -->
    <div id="login-page" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-900 via-blue-900 to-gray-900 p-4">
        <div class="glass-pane p-8 rounded-2xl w-full max-w-md">
            <!-- Logo/Header -->
            <div class="text-center mb-8">
                <h1 class="orbitron text-3xl font-bold glowing-text">Edu-Gen Prime</h1>
                <p class="text-cyan-300 mt-2">Access The Future of Education</p>
            </div>

            <!-- Login Form -->
            <div id="login-form" class="space-y-6">
                <h2 class="orbitron text-xl font-semibold text-center text-cyan-300">Sign In</h2>
                <div class="space-y-4">
                    <div>
                        <label for="login-username" class="block text-sm font-medium text-gray-400 mb-1">Username or Email</label>
                        <input type="text" id="login-username" class="w-full p-3 rounded-lg form-input" placeholder="Enter username or email" value="educator@prime.io">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-400 mb-1">Password</label>
                        <input type="password" id="login-password" class="w-full p-3 rounded-lg form-input" placeholder="Enter password" value="password123">
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="flex items-center text-sm text-gray-400">
                            <input type="checkbox" id="remember-me" class="mr-2 form-checkbox text-cyan-500 bg-gray-800 border-cyan-700">
                            Remember me
                        </label>
                        <button type="button" id="forgot-password" class="text-sm text-cyan-400 hover:underline">Forgot password?</button>
                    </div>
                </div>
                <button id="login-btn" class="w-full btn-primary py-3 px-4 rounded-lg font-bold orbitron">
                    ACCESS SYSTEM
                </button>
                <div class="text-center">
                    <span class="text-gray-400 text-sm">New to Edu-Gen Prime?</span>
                    <button id="show-signup" class="text-cyan-400 hover:underline ml-1 font-medium">Create Account</button>
                </div>
            </div>

            <!-- Signup Form -->
            <div id="signup-form" class="space-y-6 hidden">
                <h2 class="orbitron text-xl font-semibold text-center text-cyan-300">Create Account</h2>
                <div class="space-y-4">
                    <div>
                        <label for="signup-fullname" class="block text-sm font-medium text-gray-400 mb-1">Full Name</label>
                        <input type="text" id="signup-fullname" class="w-full p-3 rounded-lg form-input" placeholder="Enter your full name">
                    </div>
                    <div>
                        <label for="signup-email" class="block text-sm font-medium text-gray-400 mb-1">Email</label>
                        <input type="email" id="signup-email" class="w-full p-3 rounded-lg form-input" placeholder="Enter your email">
                    </div>
                    <div>
                        <label for="signup-password" class="block text-sm font-medium text-gray-400 mb-1">Password</label>
                        <input type="password" id="signup-password" class="w-full p-3 rounded-lg form-input" placeholder="Create password">
                    </div>
                </div>
                <button id="signup-btn" class="w-full btn-primary py-3 px-4 rounded-lg font-bold orbitron">
                    CREATE ACCOUNT
                </button>
                <div class="text-center">
                    <span class="text-gray-400 text-sm">Already have an account?</span>
                    <button id="show-login" class="text-cyan-400 hover:underline ml-1 font-medium">Sign In</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-app" class="hidden">
        <!-- Navigation Header -->
        <header class="glass-pane border-b border-cyan-500/30 sticky top-0 z-40">
            <div class="container mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <h1 class="orbitron text-2xl font-bold glowing-text">Edu-Gen Prime</h1>
                    <nav class="hidden md:flex space-x-6">
                        <button id="nav-generate" class="text-cyan-300 hover:text-white px-3 py-1 rounded transition-colors border-b-2 border-cyan-500">Generate</button>
                        <button id="nav-dashboard" class="text-gray-400 hover:text-white px-3 py-1 rounded transition-colors border-b-2 border-transparent">Dashboard</button>
                    </nav>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-300">
                        Welcome, <span id="user-name" class="text-cyan-300 font-semibold"></span>
                    </div>
                    <div class="relative">
                        <button id="profile-dropdown-btn" class="flex items-center space-x-2 text-gray-300 hover:text-white">
                            <div class="w-8 h-8 bg-gradient-to-br from-cyan-400 to-blue-600 rounded-full flex items-center justify-center">
                                <span class="text-sm font-bold" id="user-initials">U</span>
                            </div>
                        </button>
                        <div id="dropdown-menu" class="absolute right-0 mt-2 w-48 glass-pane rounded-lg shadow-lg hidden z-50">
                            <div class="py-2">
                                <button id="logout-btn" class="block w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-red-500/20 hover:text-red-300">
                                    Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Generate New Content Page -->
        <div id="generate-page" class="container mx-auto p-4 md:p-8 max-w-6xl">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Panel: Input & Customization -->
                <div class="lg:col-span-1 glass-pane p-6 rounded-2xl">
                    <h2 class="orbitron text-2xl font-semibold mb-6 border-b border-cyan-500/30 pb-3 text-cyan-300">1. Define Core Parameters</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="prompt" class="block text-sm font-medium text-gray-400 mb-1">Lesson Topic</label>
                            <input type="text" id="prompt" class="w-full p-3 rounded-lg form-input" placeholder="e.g., Quantum Entanglement">
                            <p id="copilot" class="text-xs text-cyan-400/70 h-4 mt-1"></p>
                        </div>
                        <div>
                            <label for="grade" class="block text-sm font-medium text-gray-400 mb-1">Academic Level</label>
                            <select id="grade" class="w-full p-3 rounded-lg form-input">
                                <option>High School (Introductory)</option>
                                <option>University (Undergraduate)</option>
                                <option>Postgraduate (Specialized)</option>
                            </select>
                        </div>
                        <div>
                            <label for="subject" class="block text-sm font-medium text-gray-400 mb-1">Field of Study</label>
                            <input type="text" id="subject" class="w-full p-3 rounded-lg form-input" placeholder="e.g., Physics">
                        </div>
                    </div>

                    <h2 class="orbitron text-2xl font-semibold my-6 border-b border-cyan-500/30 pb-3 text-cyan-300">2. Advanced Customization</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="modalities" class="block text-sm font-medium text-gray-400 mb-1">Learning Modalities</label>
                            <select id="modalities" class="w-full p-3 rounded-lg form-input">
                                <option>Balanced (Visual, Auditory, Kinesthetic)</option>
                                <option>Visual & Theoretical</option>
                                <option>Interactive & Project-Based</option>
                            </select>
                        </div>
                        <div>
                            <label for="context" class="block text-sm font-medium text-gray-400 mb-1">Global & Cultural Context</label>
                            <select id="context" class="w-full p-3 rounded-lg form-input">
                                <option>Standard/Global</option>
                                <option>Include Historical Context (Asian)</option>
                                <option>Include Historical Context (European)</option>
                                <option>Focus on Modern Applications</option>
                            </select>
                        </div>
                    </div>

                    <div class="mt-8">
                        <button id="generate-btn" class="w-full flex items-center justify-center font-bold py-3 px-4 rounded-lg btn-primary orbitron">
                            <svg id="generate-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M12 22h6a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v3"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M4.268 12.182a2.82 2.82 0 0 0-2.82 2.82v2.828a2.82 2.82 0 0 0 2.82 2.828h2.828a2.82 2.82 0 0 0 2.82-2.82v-2.828a2.82 2.82 0 0 0-2.82-2.82zM4 16.5h.01"/><path d="m2.5 14.5.9.9a2 2 0 0 1 0 2.8l-.9.9"/><path d="m6.5 14.5-.9.9a2 2 0 0 0 0 2.8l.9.9"/></svg>
                            <svg id="loading-spinner" class="animate-spin mr-3 h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            <span id="generate-text">Architect Lesson</span>
                        </button>
                    </div>
                </div>

                <!-- Right Panel: Output & Visualization -->
                <div id="output-container" class="lg:col-span-2 glass-pane p-6 rounded-2xl hidden">
                    <div id="error" class="text-center my-6 hidden bg-red-900/50 text-red-300 p-4 rounded-lg border border-red-500/50"></div>
                    <div id="output"></div>
                </div>

                <div id="placeholder-container" class="lg:col-span-2 glass-pane p-6 rounded-2xl flex flex-col items-center justify-center text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-400/50 mb-4"><path d="M12 20h.01"/><path d="M12 4h.01"/><path d="M20 12h.01"/><path d="M4 12h.01"/><path d="M18.36 18.36h.01"/><path d="M5.64 5.64h.01"/><path d="M18.36 5.64h.01"/><path d="M5.64 18.36h.01"/><path d="M12 16a4 4 0 1 1 0-8 4 4 0 0 1 0 8Z"/></svg>
                    <h3 class="orbitron text-2xl text-cyan-300">Awaiting Generation Signal</h3>
                    <p class="text-gray-400 mt-2">Define your lesson parameters and click "Architect Lesson" to generate the materials. The output will be visualized here.</p>
                </div>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboard-page" class="container mx-auto p-4 md:p-8 max-w-6xl hidden">
             <div class="mb-8">
                <h2 class="orbitron text-3xl font-bold glowing-text mb-4">Generation Dashboard</h2>
                <p class="text-gray-400">Manage and revisit all your generated educational content</p>
            </div>
             <!-- Content Grid -->
            <div id="dashboard-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Generated content cards will appear here -->
            </div>
             <!-- Empty State -->
            <div id="empty-state" class="text-center py-12 glass-pane rounded-2xl">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" class="text-gray-500 mx-auto mb-4"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                <h3 class="text-xl font-semibold text-gray-400 mb-2">Dashboard is Empty</h3>
                <p class="text-gray-500">Generate a lesson plan to see it appear here.</p>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="forgot-password-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="glass-pane p-6 rounded-lg max-w-md w-full mx-4">
            <h3 class="orbitron text-xl font-semibold text-cyan-300 mb-4">Reset Password</h3>
            <p class="text-gray-400 mb-4">Enter your email address to receive reset instructions.</p>
            <input type="email" id="reset-email" class="w-full p-3 rounded-lg form-input mb-4" placeholder="Enter your email">
            <div class="flex gap-3">
                <button id="send-reset" class="flex-1 btn-primary py-2 px-4 rounded-lg font-semibold">Send Reset Link</button>
                <button id="cancel-reset" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white py-2 px-4 rounded-lg font-semibold transition-colors">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- GLOBAL DOM Elements ---
            const loginPage = document.getElementById('login-page');
            const mainApp = document.getElementById('main-app');
            const generatePage = document.getElementById('generate-page');
            const dashboardPage = document.getElementById('dashboard-page');

            // --- AUTH Elements & Logic ---
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const showSignupBtn = document.getElementById('show-signup');
            const showLoginBtn = document.getElementById('show-login');
            const loginBtn = document.getElementById('login-btn');
            const signupBtn = document.getElementById('signup-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const forgotPasswordBtn = document.getElementById('forgot-password');
            const forgotPasswordModal = document.getElementById('forgot-password-modal');
            const cancelResetBtn = document.getElementById('cancel-reset');
            const sendResetBtn = document.getElementById('send-reset');
            const userNameEl = document.getElementById('user-name');
            const userInitialsEl = document.getElementById('user-initials');
            
            showSignupBtn.addEventListener('click', () => {
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
            });

            showLoginBtn.addEventListener('click', () => {
                signupForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
            });
            
            loginBtn.addEventListener('click', () => {
                const fullName = document.getElementById('login-username').value.split('@')[0] || "Educator";
                setupMainApp(fullName);
            });

            signupBtn.addEventListener('click', () => {
                const fullName = document.getElementById('signup-fullname').value || "New User";
                 setupMainApp(fullName);
            });

            logoutBtn.addEventListener('click', () => {
                mainApp.classList.add('hidden');
                loginPage.classList.remove('hidden');
                // Clear dashboard
                document.getElementById('dashboard-content').innerHTML = '';
                updateDashboardState();
            });

            forgotPasswordBtn.addEventListener('click', () => forgotPasswordModal.classList.remove('hidden'));
            cancelResetBtn.addEventListener('click', () => forgotPasswordModal.classList.add('hidden'));
            sendResetBtn.addEventListener('click', () => {
                // In a real app, you'd send an email here.
                forgotPasswordModal.classList.add('hidden');
            });
            
            function setupMainApp(fullName) {
                userNameEl.textContent = fullName;
                userInitialsEl.textContent = fullName.charAt(0).toUpperCase();
                loginPage.classList.add('hidden');
                mainApp.classList.remove('hidden');
                navigateTo('generate'); 
            }

            // --- NAVIGATION Logic ---
            const navGenerateBtn = document.getElementById('nav-generate');
            const navDashboardBtn = document.getElementById('nav-dashboard');
            const profileDropdownBtn = document.getElementById('profile-dropdown-btn');
            const dropdownMenu = document.getElementById('dropdown-menu');

            navGenerateBtn.addEventListener('click', () => navigateTo('generate'));
            navDashboardBtn.addEventListener('click', () => navigateTo('dashboard'));

            function navigateTo(page) {
                if (page === 'generate') {
                    generatePage.classList.remove('hidden');
                    dashboardPage.classList.add('hidden');
                    navGenerateBtn.classList.add('border-cyan-500', 'text-cyan-300');
                    navGenerateBtn.classList.remove('border-transparent', 'text-gray-400');
                    navDashboardBtn.classList.add('border-transparent', 'text-gray-400');
                    navDashboardBtn.classList.remove('border-cyan-500', 'text-cyan-300');
                } else if (page === 'dashboard') {
                    dashboardPage.classList.remove('hidden');
                    generatePage.classList.add('hidden');
                    navDashboardBtn.classList.add('border-cyan-500', 'text-cyan-300');
                    navDashboardBtn.classList.remove('border-transparent', 'text-gray-400');
                    navGenerateBtn.classList.add('border-transparent', 'text-gray-400');
                    navGenerateBtn.classList.remove('border-cyan-500', 'text-cyan-300');
                }
            }
            
            profileDropdownBtn.addEventListener('click', () => dropdownMenu.classList.toggle('hidden'));
            document.addEventListener('click', (e) => {
                if (!profileDropdownBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
                    dropdownMenu.classList.add('hidden');
                }
            });

            // --- GENERATION Logic ---
            const generateBtn = document.getElementById('generate-btn');
            const promptInput = document.getElementById('prompt');
            const gradeSelect = document.getElementById('grade');
            const subjectInput = document.getElementById('subject');
            const modalitiesSelect = document.getElementById('modalities');
            const contextSelect = document.getElementById('context');
            const errorDiv = document.getElementById('error');
            const outputDiv = document.getElementById('output');
            const copilotP = document.getElementById('copilot');
            const outputContainer = document.getElementById('output-container');
            const placeholderContainer = document.getElementById('placeholder-container');
            const generateIcon = document.getElementById('generate-icon');
            const loadingSpinner = document.getElementById('loading-spinner');
            const generateText = document.getElementById('generate-text');

            const suggestions = ["Photosynthesis", "The Roman Empire", "Introduction to Python", "Newton's Laws of Motion", "Literary Devices", "The Water Cycle"];
            let suggestionIndex = 0, charIndex = 0;

            function typeSuggestion() {
                if (charIndex < suggestions[suggestionIndex].length) {
                    copilotP.textContent += suggestions[suggestionIndex].charAt(charIndex++);
                    setTimeout(typeSuggestion, 50);
                } else {
                    setTimeout(eraseSuggestion, 2000);
                }
            }

            function eraseSuggestion() {
                if (charIndex > 0) {
                    copilotP.textContent = suggestions[suggestionIndex].substring(0, --charIndex);
                    setTimeout(eraseSuggestion, 30);
                } else {
                    suggestionIndex = (suggestionIndex + 1) % suggestions.length;
                    setTimeout(typeSuggestion, 500);
                }
            }
            setTimeout(typeSuggestion, 1000);

            generateBtn.addEventListener('click', generateLessonPlan);

            async function generateLessonPlan() {
                const topic = promptInput.value;
                const grade = gradeSelect.value;
                const subject = subjectInput.value;
                const modalities = modalitiesSelect.value;
                const context = contextSelect.value;

                if (!topic || !subject) {
                    showError("Please define a Lesson Topic and Field of Study.");
                    return;
                }

                startLoadingState();

                try {
                    const userPrompt = `Generate an advanced, dynamic, and engaging lesson plan on "${topic}" for a ${grade} level course in ${subject}. 
                    Tailor the content for these specific learning modalities: ${modalities}. 
                    Incorporate this context: ${context}.
                    The output must be a single JSON object. It should include a lesson title, 4 learning objectives (phrased as 'Students will be able to...'), a detailed timeline with 5 stages (Introduction, Core Concept 1, Core Concept 2, Activity, Conclusion), a 4-question multiple-choice quiz with 4 options and the correct answer indicated, and a creative homework assignment with an 'Extension Task' for advanced students.`;

                    const schema = {
                        type: "OBJECT",
                        properties: {
                            title: { type: "STRING" },
                            learning_objectives: { type: "ARRAY", items: { type: "STRING" } },
                            timeline: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: { stage: { type: "STRING" }, title: { type: "STRING" }, description: { type: "STRING" } },
                                    required: ["stage", "title", "description"]
                                }
                            },
                            quiz: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: { question: { type: "STRING" }, options: { type: "ARRAY", items: { type: "STRING" } }, answer: { type: "STRING" } },
                                    required: ["question", "options", "answer"]
                                }
                            },
                            homework: {
                                type: "OBJECT",
                                properties: { title: { type: "STRING" }, description: { type: "STRING" }, extension_task: { type: "STRING" } },
                                required: ["title", "description", "extension_task"]
                            }
                        },
                        required: ["title", "learning_objectives", "timeline", "quiz", "homework"]
                    };
                    
                    const payload = {
                        contents: [{ parts: [{ text: userPrompt }] }],
                        generationConfig: { responseMimeType: "application/json", responseSchema: schema }
                    };

                    const lessonData = await callGeminiWithBackoff(payload);
                    if (lessonData) {
                        const lessonWithMeta = { ...lessonData, id: Date.now(), date: new Date().toISOString() };
                        addContentToDashboard(lessonWithMeta);
                        renderLessonPlan(lessonData);
                    } else {
                        showError("The model returned an empty or invalid response. Please try again.");
                    }

                } catch (e) {
                    console.error(e);
                    showError(An error occurred: ${e.message});
                } finally {
                    endLoadingState();
                }
            }

            async function callGeminiWithBackoff(payload, retries = 3, delay = 1000) {
                // The API key is an empty string. It will be replaced by the execution environment.
                const apiKey = "AIzaSyDFr-fzpvf5ayLSy098qo9DKIOvnNrNlXM"; 
                const apiUrl = https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey};

                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) throw new Error(API request failed with status ${response.status});
                        const result = await response.json();
                        const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (jsonText) return JSON.parse(jsonText);
                        throw new Error("Invalid response structure from API.");
                    } catch (error) {
                        console.warn(Attempt ${i + 1} failed. Retrying...);
                        if (i === retries - 1) throw error;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    }
                }
            }

            function startLoadingState() {
                outputDiv.innerHTML = '';
                errorDiv.classList.add('hidden');
                generateIcon.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
                generateText.textContent = "GENERATING...";
                generateBtn.disabled = true;
                placeholderContainer.classList.add('hidden');
                outputContainer.classList.remove('hidden');
            }

            function endLoadingState() {
                loadingSpinner.classList.add('hidden');
                generateIcon.classList.remove('hidden');
                generateText.textContent = "Architect Lesson";
                generateBtn.disabled = false;
            }

            function showError(message) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
            }

            function renderLessonPlan(data) {
                outputDiv.innerHTML = `
                    <div class="space-y-8">
                        <div class="fade-in text-center border-b border-cyan-500/30 pb-4">
                            <h2 class="orbitron text-3xl font-bold glowing-text">${data.title}</h2>
                        </div>
                        ${renderSection('🎯', 'Learning Objectives', renderObjectives(data.learning_objectives))}
                        ${renderSection('⏳', 'Lesson Timeline', renderTimeline(data.timeline))}
                        ${renderSection('❓', 'Assessment Quiz', renderQuiz(data.quiz))}
                        ${renderSection('📚', 'Homework Assignment', renderHomework(data.homework))}
                    </div>`;
            }

            function renderSection(icon, title, content) {
                return `
                    <section class="fade-in" style="animation-delay: 150ms;">
                        <h3 class="orbitron text-2xl font-semibold text-cyan-300 mb-4 flex items-center">
                            <span class="mr-3 text-2xl">${icon}</span>
                            ${title}
                        </h3>
                        <div class="pl-4 border-l-2 border-cyan-500/30">${content}</div>
                    </section>`;
            }

            function renderObjectives(objectives) {
                return `<ul class="space-y-2 text-gray-300">${objectives.map(obj => `
                    <li class="flex items-start">
                        <svg class="w-4 h-4 mr-2 mt-1 text-cyan-400 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        <span>${obj}</span>
                    </li>`).join('')}
                </ul>`;
            }

            function renderTimeline(timeline) {
                return `<div class="relative">${timeline.map(item => `
                    <div class="timeline-item">
                        <p class="font-semibold orbitron text-cyan-400">${item.stage}: ${item.title}</p>
                        <p class="text-gray-400 text-sm mt-1">${item.description}</p>
                    </div>`).join('')}
                </div>`;
            }

            function renderQuiz(quiz) {
                return `<div class="space-y-4">${quiz.map((q, index) => `
                    <div class="glass-pane p-4 rounded-lg border border-cyan-500/20">
                        <p class="font-medium">${index + 1}. ${q.question}</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-3">
                            ${q.options.map(opt => <button class="text-left text-sm p-2 rounded-md hover:bg-cyan-500/20 border border-transparent hover:border-cyan-500 transition">${opt}</button>).join('')}
                        </div>
                        <div class="mt-3">
                            <button class="text-xs font-semibold text-cyan-400 hover:underline" onclick="this.nextElementSibling.classList.toggle('hidden')">Toggle Answer</button>
                            <p class="hidden mt-2 p-2 bg-cyan-900/50 text-cyan-200 rounded-md text-sm border border-cyan-500/50">Correct Answer: <strong>${q.answer}</strong></p>
                        </div>
                    </div>`).join('')}
                </div>`;
            }

            function renderHomework(homework) {
                return `<div class="glass-pane p-5 rounded-lg border border-cyan-500/20">
                    <h4 class="font-bold orbitron text-cyan-400">${homework.title}</h4>
                    <p class="mt-2 text-gray-300">${homework.description}</p>
                    <div class="mt-4 pt-4 border-t border-cyan-500/20">
                        <h5 class="font-semibold text-cyan-400 text-sm">Extension Task</h5>
                        <p class="mt-1 text-gray-400 text-sm">${homework.extension_task}</p>
                    </div>
                </div>`;
            }

            // --- DASHBOARD Logic ---
            let generatedContent = [];
            const dashboardContent = document.getElementById('dashboard-content');
            const emptyState = document.getElementById('empty-state');
            
            function addContentToDashboard(item) {
                generatedContent.unshift(item); // Add to the beginning
                renderDashboard();
            }

            function renderDashboard() {
                dashboardContent.innerHTML = '';
                if(generatedContent.length === 0) {
                   updateDashboardState();
                   return;
                }
                
                generatedContent.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'glass-pane p-4 rounded-lg flex flex-col justify-between hover:border-cyan-500/50 border border-transparent transition-all';
                    card.innerHTML = `
                        <div>
                           <div class="mb-2">
                                <span class="text-xs bg-cyan-500/20 text-cyan-300 px-2 py-1 rounded">Lesson Plan</span>
                           </div>
                           <h4 class="font-bold text-lg text-gray-200 mb-2">${item.title}</h4>
                           <p class="text-xs text-gray-500">Generated on ${new Date(item.date).toLocaleDateString()}</p>
                        </div>
                        <button class="mt-4 w-full text-center bg-gray-600 hover:bg-gray-500 text-white py-2 px-4 rounded-lg font-semibold transition-colors">
                            View Details
                        </button>
                    `;
                    dashboardContent.appendChild(card);
                });
                updateDashboardState();
            }
            
            function updateDashboardState() {
                if (generatedContent.length > 0) {
                    emptyState.classList.add('hidden');
                    dashboardContent.classList.remove('hidden');
                } else {
                    emptyState.classList.remove('hidden');
                    dashboardContent.classList.add('hidden');
                }
            }
            // Initial call
            updateDashboardState();
        });
    </script>
</body>
</html>
